<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>topo.misc.fixedpoint &mdash; Topographica</title>
    
    <link rel="stylesheet" href="../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.9.8',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../_static/custom.js"></script>
    <link rel="shortcut icon" href="../../../_static/topo-favicon.ico"/>
    <link rel="top" title="Topographica" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>

<li><a href="../../../index.html">Home</a></li>
<li><a href="../../../Downloads/index.html">Downloads</a></li>
<li><a href="../../../Tutorials/index.html">Tutorials</a></li>
<li><a href="../../../User_Manual/index.html">User Manual</a></li>



<li><ul class="parents">



          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li>

</ul></li>


      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for topo.misc.fixedpoint</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">FixedPoint objects support decimal arithmetic with a fixed number of</span>
<span class="sd">digits (called the object&#39;s precision) after the decimal point.  The</span>
<span class="sd">number of digits before the decimal point is variable &amp; unbounded.</span>

<span class="sd">The precision is user-settable on a per-object basis when a FixedPoint</span>
<span class="sd">is constructed, and may vary across FixedPoint objects.  The precision</span>
<span class="sd">may also be changed after construction via FixedPoint.set_precision(p).</span>
<span class="sd">Note that if the precision of a FixedPoint is reduced via set_precision,</span>
<span class="sd">information may be lost to rounding.</span>

<span class="sd">&gt;&gt;&gt; x = FixedPoint(&quot;5.55&quot;)  # precision defaults to 2</span>
<span class="sd">&gt;&gt;&gt; print x</span>
<span class="sd">5.55</span>
<span class="sd">&gt;&gt;&gt; x.set_precision(1)      # round to one fraction digit</span>
<span class="sd">&gt;&gt;&gt; print x</span>
<span class="sd">5.6</span>
<span class="sd">&gt;&gt;&gt; print FixedPoint(&quot;5.55&quot;, 1)  # same thing setting to 1 in constructor</span>
<span class="sd">5.6</span>
<span class="sd">&gt;&gt;&gt; repr(x) #  returns constructor string that reproduces object exactly</span>
<span class="sd">&quot;FixedPoint(&#39;5.6&#39;, 1)&quot;</span>
<span class="sd">&gt;&gt;&gt;</span>

<span class="sd">When FixedPoint objects of different precision are combined via + - * /,</span>
<span class="sd">the result is computed to the larger of the inputs&#39; precisions, which also</span>
<span class="sd">becomes the precision of the resulting FixedPoint object.</span>

<span class="sd">&gt;&gt;&gt; print FixedPoint(&quot;3.42&quot;) + FixedPoint(&quot;100.005&quot;, 3)</span>
<span class="sd">103.425</span>
<span class="sd">&gt;&gt;&gt;</span>

<span class="sd">When a FixedPoint is combined with other numeric types (ints, floats,</span>
<span class="sd">strings representing a number) via + - * /, then similarly the computation</span>
<span class="sd">is carried out using-- and the result inherits --the FixedPoint&#39;s</span>
<span class="sd">precision.</span>

<span class="sd">&gt;&gt;&gt; print FixedPoint(1) / 7</span>
<span class="sd">0.14</span>
<span class="sd">&gt;&gt;&gt; print FixedPoint(1, 30) / 7</span>
<span class="sd">0.142857142857142857142857142857</span>
<span class="sd">&gt;&gt;&gt;</span>

<span class="sd">The string produced by str(x) (implictly invoked by &quot;print&quot;) always</span>
<span class="sd">contains at least one digit before the decimal point, followed by a</span>
<span class="sd">decimal point, followed by exactly x.get_precision() digits.  If x is</span>
<span class="sd">negative, str(x)[0] == &quot;-&quot;.</span>

<span class="sd">The FixedPoint constructor can be passed an int, long, string, float,</span>
<span class="sd">FixedPoint, or any object convertible to a float via float() or to a</span>
<span class="sd">long via long().  Passing a precision is optional; if specified, the</span>
<span class="sd">precision must be a non-negative int.  There is no inherent limit on</span>
<span class="sd">the size of the precision, but if very very large you&#39;ll probably run</span>
<span class="sd">out of memory.</span>

<span class="sd">Note that conversion of floats to FixedPoint can be surprising, and</span>
<span class="sd">should be avoided whenever possible.  Conversion from string is exact</span>
<span class="sd">(up to final rounding to the requested precision), so is greatly</span>
<span class="sd">preferred.</span>

<span class="sd">&gt;&gt;&gt; print FixedPoint(1.1e30)</span>
<span class="sd">1099999999999999993725589651456.00</span>
<span class="sd">&gt;&gt;&gt; print FixedPoint(&quot;1.1e30&quot;)</span>
<span class="sd">1100000000000000000000000000000.00</span>
<span class="sd">&gt;&gt;&gt;</span>

<span class="sd">The following Python operators and functions accept FixedPoints in the</span>
<span class="sd">expected ways:</span>

<span class="sd">    binary + - * / % divmod</span>
<span class="sd">        with auto-coercion of other types to FixedPoint.</span>
<span class="sd">        + - % divmod  of FixedPoints are always exact.</span>
<span class="sd">        * / of FixedPoints may lose information to rounding, in</span>
<span class="sd">            which case the result is the infinitely precise answer</span>
<span class="sd">            rounded to the result&#39;s precision.</span>
<span class="sd">        divmod(x, y) returns (q, r) where q is a long equal to</span>
<span class="sd">            floor(x/y) as if x/y were computed to infinite precision,</span>
<span class="sd">            and r is a FixedPoint equal to x - q * y; no information</span>
<span class="sd">            is lost.  Note that q has the sign of y, and abs(r) &lt; abs(y).</span>
<span class="sd">    unary -</span>
<span class="sd">    == != &lt; &gt; &lt;= &gt;=  cmp</span>
<span class="sd">    min  max</span>
<span class="sd">    float  int  long    (int and long truncate)</span>
<span class="sd">    abs</span>
<span class="sd">    str  repr</span>
<span class="sd">    hash</span>
<span class="sd">    use as dict keys</span>
<span class="sd">    use as boolean (e.g. &quot;if some_FixedPoint:&quot; -- true iff not zero)</span>

<span class="sd">Methods unique to FixedPoints:</span>
<span class="sd">   .copy()              return new FixedPoint with same value</span>
<span class="sd">   .frac()              long(x) + x.frac() == x</span>
<span class="sd">   .get_precision()     return the precision(p) of this FixedPoint object</span>
<span class="sd">   .set_precision(p)    set the precision of this FixedPoint object</span>

<span class="sd">Provided as-is; use at your own risk; no warranty; no promises; enjoy!</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c"># Released to the public domain 28-Mar-2001,</span>
<span class="c"># by Tim Peters (tim.one@home.com).</span>


<span class="c"># 28-Mar-01 ver 0.0,4</span>
<span class="c">#     Use repr() instead of str() inside __str__, because str(long) changed</span>
<span class="c">#     since this was first written (used to produce trailing &quot;L&quot;, doesn&#39;t</span>
<span class="c">#     now).</span>
<span class="c">#</span>
<span class="c"># 09-May-99 ver 0,0,3</span>
<span class="c">#     Repaired __sub__(FixedPoint, string); was blowing up.</span>
<span class="c">#     Much more careful conversion of float (now best possible).</span>
<span class="c">#     Implemented exact % and divmod.</span>
<span class="c">#</span>
<span class="c"># 14-Oct-98 ver 0,0,2</span>
<span class="c">#     Added int, long, frac.  Beefed up docs.  Removed DECIMAL_POINT</span>
<span class="c">#     and MINUS_SIGN globals to discourage bloating this class instead</span>
<span class="c">#     of writing formatting wrapper classes (or subclasses)</span>
<span class="c">#</span>
<span class="c"># 11-Oct-98 ver 0,0,1</span>
<span class="c">#     posted to c.l.py</span>

<span class="n">__copyright__</span> <span class="o">=</span> <span class="s">&quot;Copyright (C) Python Software Foundation&quot;</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s">&quot;Tim Peters&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>

<div class="viewcode-block" id="bankersRounding"><a class="viewcode-back" href="../../../Reference_Manual/topo.misc.html#topo.misc.fixedpoint.bankersRounding">[docs]</a><span class="k">def</span> <span class="nf">bankersRounding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dividend</span><span class="p">,</span> <span class="n">divisor</span><span class="p">,</span> <span class="n">quotient</span><span class="p">,</span> <span class="n">remainder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    rounding via nearest-even</span>
<span class="sd">    increment the quotient if</span>
<span class="sd">         the remainder is more than half of the divisor</span>
<span class="sd">      or the remainder is exactly half the divisor and the quotient is odd</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="nb">cmp</span><span class="p">(</span><span class="n">remainder</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">divisor</span><span class="p">)</span>
    <span class="c"># c &lt; 0 &lt;-&gt; remainder &lt; divisor/2, etc</span>
    <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">quotient</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">quotient</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">quotient</span>
</div>
<div class="viewcode-block" id="addHalfAndChop"><a class="viewcode-back" href="../../../Reference_Manual/topo.misc.html#topo.misc.fixedpoint.addHalfAndChop">[docs]</a><span class="k">def</span> <span class="nf">addHalfAndChop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dividend</span><span class="p">,</span> <span class="n">divisor</span><span class="p">,</span> <span class="n">quotient</span><span class="p">,</span> <span class="n">remainder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    the equivalent of &#39;add half and chop&#39;</span>
<span class="sd">    increment the quotient if</span>
<span class="sd">         the remainder is greater than half of the divisor</span>
<span class="sd">      or the remainder is exactly half the divisor and the quotient is &gt;= 0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="nb">cmp</span><span class="p">(</span><span class="n">remainder</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">divisor</span><span class="p">)</span>
    <span class="c"># c &lt; 0 &lt;-&gt; remainder &lt; divisor/2, etc</span>
    <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">quotient</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">quotient</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">quotient</span>

<span class="c"># 2002-10-20 dougfort - fake classes for pre 2.2 compatibility</span></div>
<span class="k">try</span><span class="p">:</span>
    <span class="nb">object</span>
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
    <span class="k">class</span> <span class="nc">object</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">property</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="c"># The default value for the number of decimal digits carried after the</span>
<span class="c"># decimal point.  This only has effect at instance initialization.</span>
<span class="n">DEFAULT_PRECISION</span> <span class="o">=</span> <span class="mi">2</span>

<div class="viewcode-block" id="FixedPoint"><a class="viewcode-back" href="../../../Reference_Manual/topo.misc.html#topo.misc.fixedpoint.FixedPoint">[docs]</a><span class="k">class</span> <span class="nc">FixedPoint</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Basic FixedPoint object class,</span>
<span class="sd">        The exact value is self.n / 10**self.p;</span>
<span class="sd">        self.n is a long; self.p is an int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;n&#39;</span><span class="p">,</span> <span class="s">&#39;p&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">precision</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">precision</span> <span class="o">=</span> <span class="n">DEFAULT_PRECISION</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_precision</span><span class="p">(</span><span class="n">precision</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="s">&quot;42.3e5&quot;</span><span class="p">)):</span>
            <span class="n">n</span><span class="p">,</span> <span class="n">exp</span> <span class="o">=</span> <span class="n">_string2exact</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="c"># exact value is n*10**exp = n*10**(exp+p)/10**p</span>
            <span class="n">effective_exp</span> <span class="o">=</span> <span class="n">exp</span> <span class="o">+</span> <span class="n">p</span>
            <span class="k">if</span> <span class="n">effective_exp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="n">_tento</span><span class="p">(</span><span class="n">effective_exp</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">effective_exp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roundquotient</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">_tento</span><span class="p">(</span><span class="o">-</span><span class="n">effective_exp</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="mi">42</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="il">42L</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="nb">long</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span> <span class="n">_tento</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">temp</span><span class="o">.</span><span class="n">set_precision</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">temp</span><span class="o">.</span><span class="n">p</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="mf">42.0</span><span class="p">)):</span>
            <span class="c"># XXX ignoring infinities and NaNs and overflows for now</span>
            <span class="kn">import</span> <span class="nn">math</span>
            <span class="n">f</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">frexp</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">assert</span> <span class="n">f</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="mf">0.5</span> <span class="o">&lt;=</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="mf">1.0</span>
            <span class="c"># |value| = f * 2**e exactly</span>

            <span class="c"># Suck up CHUNK bits at a time; 28 is enough so that we suck</span>
            <span class="c"># up all bits in 2 iterations for all known binary double-</span>
            <span class="c"># precision formats, and small enough to fit in an int.</span>
            <span class="n">CHUNK</span> <span class="o">=</span> <span class="mi">28</span>
            <span class="n">top</span> <span class="o">=</span> <span class="il">0L</span>
            <span class="c"># invariant: |value| = (top + f) * 2**e exactly</span>
            <span class="k">while</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ldexp</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">CHUNK</span><span class="p">)</span>
                <span class="n">digit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">digit</span> <span class="o">&gt;&gt;</span> <span class="n">CHUNK</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="n">top</span> <span class="o">=</span> <span class="p">(</span><span class="n">top</span> <span class="o">&lt;&lt;</span> <span class="n">CHUNK</span><span class="p">)</span> <span class="o">|</span> <span class="n">digit</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">f</span> <span class="o">-</span> <span class="n">digit</span>
                <span class="k">assert</span> <span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="mf">1.0</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">e</span> <span class="o">-</span> <span class="n">CHUNK</span>

            <span class="c"># now |value| = top * 2**e exactly</span>
            <span class="c"># want n such that n / 10**p = top * 2**e, or</span>
            <span class="c"># n = top * 10**p * 2**e</span>
            <span class="n">top</span> <span class="o">=</span> <span class="n">top</span> <span class="o">*</span> <span class="n">_tento</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">e</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">top</span> <span class="o">&lt;&lt;</span> <span class="n">e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roundquotient</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="il">1L</span> <span class="o">&lt;&lt;</span> <span class="o">-</span><span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="o">-</span><span class="n">n</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="mi">42</span><span class="o">-</span><span class="mi">42j</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;can&#39;t convert complex to FixedPoint: &quot;</span> <span class="o">+</span>
                            <span class="sb">`value`</span><span class="p">)</span>

        <span class="c"># can we coerce to a float?</span>
        <span class="n">yes</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">asfloat</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">yes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">yes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">asfloat</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c"># similarly for long</span>
        <span class="n">yes</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">aslong</span> <span class="o">=</span> <span class="nb">long</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">yes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">yes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">aslong</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;can&#39;t convert to FixedPoint: &quot;</span> <span class="o">+</span> <span class="sb">`value`</span><span class="p">)</span>

<div class="viewcode-block" id="FixedPoint.get_precision"><a class="viewcode-back" href="../../../Reference_Manual/topo.misc.html#topo.misc.fixedpoint.FixedPoint.get_precision">[docs]</a>    <span class="k">def</span> <span class="nf">get_precision</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the precision of this FixedPoint.</span>

<span class="sd">           The precision is the number of decimal digits carried after</span>
<span class="sd">           the decimal point, and is an int &gt;= 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span>
</div>
<div class="viewcode-block" id="FixedPoint.set_precision"><a class="viewcode-back" href="../../../Reference_Manual/topo.misc.html#topo.misc.fixedpoint.FixedPoint.set_precision">[docs]</a>    <span class="k">def</span> <span class="nf">set_precision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="n">DEFAULT_PRECISION</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change the precision carried by this FixedPoint to p.</span>

<span class="sd">           precision must be an int &gt;= 0, and defaults to</span>
<span class="sd">           DEFAULT_PRECISION.</span>

<span class="sd">           If precision is less than this FixedPoint&#39;s current precision,</span>
<span class="sd">           information may be lost to rounding.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">precision</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;precision not convertable to int: &quot;</span> <span class="o">+</span>
                            <span class="sb">`precision`</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;precision must be &gt;= 0: &quot;</span> <span class="o">+</span> <span class="sb">`precision`</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">*</span> <span class="n">_tento</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_roundquotient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">_tento</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">-</span> <span class="n">p</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span>
</div>
    <span class="n">precision</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_precision</span><span class="p">,</span> <span class="n">set_precision</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">_tento</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">frac</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">f</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">frac</span> <span class="o">=</span> <span class="s">&quot;0&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">frac</span><span class="p">))</span> <span class="o">+</span> <span class="n">frac</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">frac</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&quot;-&quot;</span><span class="p">[:</span><span class="n">n</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> \
               <span class="nb">repr</span><span class="p">(</span><span class="n">i</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
               <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">frac</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;FixedPoint&quot;</span> <span class="o">+</span> <span class="sb">`(str(self), self.p)`</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_mkFP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="n">__copy__</span> <span class="o">=</span> <span class="n">copy</span>

    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memo</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c"># Basic support for pickling</span>
    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">state</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__slots__</span><span class="p">:</span>
                <span class="n">state</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">state</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unpickle</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">unpickle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>


    <span class="k">def</span> <span class="nf">__cmp__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">xn</span><span class="p">,</span> <span class="n">yn</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">FixedPoint</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">cmp</span><span class="p">(</span><span class="n">xn</span><span class="p">,</span> <span class="n">yn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Caution!  == values must have equal hashes, and a FixedPoint</span>
<span class="sd">            is essentially a rational in unnormalized form.  There&#39;s</span>
<span class="sd">            really no choice here but to normalize it, so hash is</span>
<span class="sd">            potentially expensive.</span>
<span class="sd">            n, p = self.__reduce()</span>

<span class="sd">            Obscurity: if the value is an exact integer, p will be 0 now,</span>
<span class="sd">            so the hash expression reduces to hash(n).  So FixedPoints</span>
<span class="sd">            that happen to be exact integers hash to the same things as</span>
<span class="sd">            their int or long equivalents.  This is Good.  But if a</span>
<span class="sd">            FixedPoint happens to have a value exactly representable as</span>
<span class="sd">            a float, their hashes may differ.  This is a teensy bit Bad.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reduce</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">^</span> <span class="nb">hash</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns true if this FixedPoint is not equal to zero&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__neg__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_mkFP</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__abs__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns new FixedPoint containing the absolute value of this FixedPoint&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">FixedPoint</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="c"># n1/10**p + n2/10**p = (n1+n2)/10**p</span>
        <span class="k">return</span> <span class="n">_mkFP</span><span class="p">(</span><span class="n">n1</span> <span class="o">+</span> <span class="n">n2</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="n">__radd__</span> <span class="o">=</span> <span class="n">__add__</span>

    <span class="k">def</span> <span class="nf">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)):</span>
            <span class="n">other</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__add__</span><span class="p">(</span><span class="o">-</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__rsub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="p">)</span> <span class="o">+</span> <span class="n">other</span>

    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">FixedPoint</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="c"># n1/10**p * n2/10**p = (n1*n2/10**p)/10**p</span>
        <span class="k">return</span> <span class="n">_mkFP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_roundquotient</span><span class="p">(</span><span class="n">n1</span> <span class="o">*</span> <span class="n">n2</span><span class="p">,</span> <span class="n">_tento</span><span class="p">(</span><span class="n">p</span><span class="p">)),</span> <span class="n">p</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="n">__rmul__</span> <span class="o">=</span> <span class="n">__mul__</span>

    <span class="k">def</span> <span class="nf">__div__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">FixedPoint</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">n2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ZeroDivisionError</span><span class="p">(</span><span class="s">&quot;FixedPoint division&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="o">=</span> <span class="o">-</span><span class="n">n1</span><span class="p">,</span> <span class="o">-</span><span class="n">n2</span>
        <span class="c"># n1/10**p / (n2/10**p) = n1/n2 = (n1*10**p/n2)/10**p</span>
        <span class="k">return</span> <span class="n">_mkFP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_roundquotient</span><span class="p">(</span><span class="n">n1</span> <span class="o">*</span> <span class="n">_tento</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">n2</span><span class="p">),</span> <span class="n">p</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__rdiv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">FixedPoint</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">_mkFP</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">FixedPoint</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span> <span class="o">/</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__divmod__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">FixedPoint</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">n2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ZeroDivisionError</span><span class="p">(</span><span class="s">&quot;FixedPoint modulo&quot;</span><span class="p">)</span>
        <span class="c"># floor((n1/10**p)/(n2*10**p)) = floor(n1/n2)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">n1</span> <span class="o">/</span> <span class="n">n2</span>
        <span class="c"># n1/10**p - q * n2/10**p = (n1 - q * n2)/10**p</span>
        <span class="k">return</span> <span class="n">q</span><span class="p">,</span> <span class="n">_mkFP</span><span class="p">(</span><span class="n">n1</span> <span class="o">-</span> <span class="n">q</span> <span class="o">*</span> <span class="n">n2</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__rdivmod__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">FixedPoint</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">_mkFP</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__mod__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__divmod__</span><span class="p">(</span><span class="n">other</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__rmod__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">FixedPoint</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">_mkFP</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span><span class="o">.</span><span class="n">__mod__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__float__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the floating point representation of this FixedPoint.</span>
<span class="sd">            Caution! float can lose precision.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reduce</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">_tento</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__long__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;EJG/DF - Should this round instead?</span>
<span class="sd">            Note e.g. long(-1.9) == -1L and long(1.9) == 1L in Python</span>
<span class="sd">            Note that __int__ inherits whatever __long__ does,</span>
<span class="sd">                 and .frac() is affected too</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="n">_tento</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">answer</span> <span class="o">=</span> <span class="o">-</span><span class="n">answer</span>
        <span class="k">return</span> <span class="n">answer</span>

    <span class="k">def</span> <span class="nf">__int__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return integer value of FixedPoint object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__long__</span><span class="p">())</span>

<div class="viewcode-block" id="FixedPoint.frac"><a class="viewcode-back" href="../../../Reference_Manual/topo.misc.html#topo.misc.fixedpoint.FixedPoint.frac">[docs]</a>    <span class="k">def</span> <span class="nf">frac</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return fractional portion as a FixedPoint.</span>

<span class="sd">           x.frac() + long(x) == x</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span> <span class="o">-</span> <span class="nb">long</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">_roundquotient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Divide x by y,</span>
<span class="sd">        return the result of rounding</span>
<span class="sd">        Developers may substitute their own &#39;round&#39; for custom rounding</span>
<span class="sd">        y must be &gt; 0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">leftover</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">leftover</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return n, p s.t. self == n/10**p and n % 10 != 0&quot;&quot;&quot;</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">p</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="mi">10</span>
        <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span>

<span class="c"># 2002-10-04 dougfort - Default to Banker&#39;s Rounding for backward compatibility</span></div>
<span class="n">FixedPoint</span><span class="o">.</span><span class="n">round</span> <span class="o">=</span> <span class="n">bankersRounding</span>

<span class="c"># return 10L**n</span>

<span class="k">def</span> <span class="nf">_tento</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="p">{}):</span>
    <span class="sd">&quot;&quot;&quot;Cached computation of 10**n&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cache</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="il">10L</span> <span class="o">**</span> <span class="n">n</span>
        <span class="k">return</span> <span class="n">answer</span>

<span class="k">def</span> <span class="nf">_norm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="nb">isinstance</span><span class="o">=</span><span class="nb">isinstance</span><span class="p">,</span> <span class="n">FixedPoint</span><span class="o">=</span><span class="n">FixedPoint</span><span class="p">,</span>
                <span class="n">_tento</span><span class="o">=</span><span class="n">_tento</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return xn, yn, p s.t.</span>
<span class="sd">           p = max(x.p, y.p)</span>
<span class="sd">           x = xn / 10**p</span>
<span class="sd">           y = yn / 10**p</span>

<span class="sd">        x must be FixedPoint to begin with; if y is not FixedPoint,</span>
<span class="sd">        it inherits its precision from x.</span>

<span class="sd">        Note that this method is called a lot, so default-arg tricks are helpful.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">FixedPoint</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">FixedPoint</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">FixedPoint</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
    <span class="n">xn</span><span class="p">,</span> <span class="n">yn</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">n</span>
    <span class="n">xp</span><span class="p">,</span> <span class="n">yp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">p</span>
    <span class="k">if</span> <span class="n">xp</span> <span class="o">&gt;</span> <span class="n">yp</span><span class="p">:</span>
        <span class="n">yn</span> <span class="o">=</span> <span class="n">yn</span> <span class="o">*</span> <span class="n">_tento</span><span class="p">(</span><span class="n">xp</span> <span class="o">-</span> <span class="n">yp</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">xp</span>
    <span class="k">elif</span> <span class="n">xp</span> <span class="o">&lt;</span> <span class="n">yp</span><span class="p">:</span>
        <span class="n">xn</span> <span class="o">=</span> <span class="n">xn</span> <span class="o">*</span> <span class="n">_tento</span><span class="p">(</span><span class="n">yp</span> <span class="o">-</span> <span class="n">xp</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">yp</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">xp</span>  <span class="c"># same as yp</span>
    <span class="k">return</span> <span class="n">xn</span><span class="p">,</span> <span class="n">yn</span><span class="p">,</span> <span class="n">p</span>

<span class="k">def</span> <span class="nf">_mkFP</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">FixedPoint</span><span class="o">=</span><span class="n">FixedPoint</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make FixedPoint objext - Return a new FixedPoint object with the selected precision.&quot;&quot;&quot;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">FixedPoint</span><span class="p">()</span>
    <span class="c">#print &#39;_mkFP Debug: %s, value=%s&#39; % (type(f),n)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span>
    <span class="n">f</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span>
    <span class="k">return</span> <span class="n">f</span>

<span class="c"># crud for parsing strings</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="c"># There&#39;s an optional sign at the start, and an optional exponent</span>
<span class="c"># at the end.  The exponent has an optional sign and at least one</span>
<span class="c"># digit.  In between, must have either at least one digit followed</span>
<span class="c"># by an optional fraction, or a decimal point followed by at least</span>
<span class="c"># one digit.  Yuck.</span>

<span class="n">_parser</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;&quot;&quot;</span>
<span class="s">    \s*</span>
<span class="s">    (?P&lt;sign&gt;[-+])?</span>
<span class="s">    (</span>
<span class="s">        (?P&lt;int&gt;\d+) (\. (?P&lt;frac&gt;\d*))?</span>
<span class="s">    |</span>
<span class="s">        \. (?P&lt;onlyfrac&gt;\d+)</span>
<span class="s">    )</span>
<span class="s">    ([eE](?P&lt;exp&gt;[-+]? \d+))?</span>
<span class="s">    \s* $</span>
<span class="s">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span><span class="o">.</span><span class="n">match</span>

<span class="k">del</span> <span class="n">re</span>


<span class="k">def</span> <span class="nf">_string2exact</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return n, p s.t. float string value == n * 10**p exactly.&quot;&quot;&quot;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">_parser</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;can&#39;t parse as number: &quot;</span> <span class="o">+</span> <span class="sb">`s`</span><span class="p">)</span>

    <span class="n">exp</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;exp&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">exp</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span>

    <span class="n">intpart</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;int&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">intpart</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">intpart</span> <span class="o">=</span> <span class="s">&quot;0&quot;</span>
        <span class="n">fracpart</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;onlyfrac&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fracpart</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;frac&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fracpart</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">fracpart</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="n">fracpart</span> <span class="o">=</span> <span class="s">&quot;0&quot;</span>
    <span class="k">assert</span> <span class="n">intpart</span>
    <span class="k">assert</span> <span class="n">fracpart</span>

    <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="nb">long</span><span class="p">(</span><span class="n">intpart</span><span class="p">),</span> <span class="nb">long</span><span class="p">(</span><span class="n">fracpart</span><span class="p">)</span>
    <span class="n">nfrac</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fracpart</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">_tento</span><span class="p">(</span><span class="n">nfrac</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span>
    <span class="n">exp</span> <span class="o">=</span> <span class="n">exp</span> <span class="o">-</span> <span class="n">nfrac</span>

    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;sign&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;-&quot;</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="n">i</span>

    <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="n">exp</span>

<span class="k">def</span> <span class="nf">_test</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Unit testing framework&quot;&quot;&quot;</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">FixedPoint</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">fp</span><span class="p">(</span><span class="s">&quot;0.1&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;0.10&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">fp</span><span class="p">(</span><span class="s">&quot;-20e-2&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;-0.20000&quot;</span>
    <span class="k">assert</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">o</span>
    <span class="k">assert</span> <span class="n">o</span> <span class="o">&gt;</span> <span class="n">t</span>
    <span class="k">assert</span> <span class="nb">min</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span> <span class="o">==</span> <span class="n">t</span>
    <span class="k">assert</span> <span class="nb">max</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span> <span class="o">==</span> <span class="n">o</span>
    <span class="k">assert</span> <span class="n">o</span> <span class="o">!=</span> <span class="n">t</span>
    <span class="k">assert</span> <span class="o">--</span><span class="n">t</span> <span class="o">==</span> <span class="n">t</span>
    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">o</span> <span class="o">==</span> <span class="n">o</span> <span class="ow">and</span> <span class="n">t</span> <span class="o">==</span> <span class="n">t</span>
    <span class="k">assert</span> <span class="n">t</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">==</span> <span class="n">t</span>
    <span class="k">assert</span> <span class="n">o</span> <span class="o">==</span> <span class="o">-</span><span class="n">t</span><span class="o">/</span><span class="mi">2</span> <span class="o">==</span> <span class="o">-.</span><span class="mi">5</span> <span class="o">*</span> <span class="n">t</span>
    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="n">o</span> <span class="o">+</span> <span class="n">o</span>
    <span class="k">assert</span> <span class="nb">abs</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">==</span> <span class="n">o</span>
    <span class="k">assert</span> <span class="n">o</span><span class="o">/</span><span class="n">t</span> <span class="o">==</span> <span class="o">-</span><span class="mf">0.5</span>
    <span class="k">assert</span> <span class="o">-</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="n">o</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">/</span><span class="n">o</span> <span class="o">==</span> <span class="n">t</span><span class="o">/-</span><span class="n">o</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="k">assert</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">o</span> <span class="o">==</span> <span class="n">o</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">fp</span><span class="p">(</span><span class="s">&quot; +00.000011e+5  &quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="mi">1</span><span class="o">/</span><span class="n">o</span> <span class="o">==</span> <span class="mi">10</span>
    <span class="k">assert</span> <span class="n">o</span> <span class="o">+</span> <span class="n">t</span> <span class="o">==</span> <span class="n">t</span> <span class="o">+</span> <span class="n">o</span> <span class="o">==</span> <span class="o">-</span><span class="n">o</span>
    <span class="k">assert</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">t</span> <span class="o">==</span> <span class="n">t</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">==</span> <span class="s">&quot;2&quot;</span> <span class="o">*</span> <span class="n">t</span> <span class="o">==</span> <span class="n">o</span><span class="o">/</span><span class="n">o</span> <span class="o">*</span> <span class="il">2L</span> <span class="o">*</span> <span class="n">t</span>
    <span class="k">assert</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">t</span> <span class="o">==</span> <span class="o">-</span><span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">fp</span><span class="p">(</span><span class="il">6L</span><span class="p">)</span><span class="o">/</span><span class="mi">5</span>
    <span class="k">assert</span> <span class="n">t</span><span class="o">*</span><span class="n">t</span> <span class="o">==</span> <span class="mi">4</span><span class="o">*</span><span class="n">o</span><span class="o">*</span><span class="n">o</span> <span class="o">==</span> <span class="n">o</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">o</span> <span class="o">==</span> <span class="n">o</span><span class="o">*</span><span class="n">o</span><span class="o">*</span><span class="mi">4</span>
    <span class="k">assert</span> <span class="n">fp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="s">&quot;1&quot;</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="nb">float</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">t</span><span class="p">)</span> <span class="o">==</span> <span class="mf">5.0</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
        <span class="k">assert</span> <span class="mi">42</span> <span class="o">+</span> <span class="n">fp</span><span class="p">(</span><span class="s">&quot;1e-20&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="mi">42</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">42</span> <span class="o">+</span> <span class="n">fp</span><span class="p">(</span><span class="s">&quot;1e-20&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="o">-</span> <span class="mi">42</span><span class="p">)</span> <span class="o">==</span> <span class="n">fp</span><span class="p">(</span><span class="s">&quot;100.0E18&quot;</span><span class="p">)</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">fp</span><span class="p">(</span><span class="s">&quot;.9995&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="k">assert</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">o</span> <span class="o">==</span> <span class="n">fp</span><span class="p">(</span><span class="s">&quot;5e-4&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">o</span><span class="o">.</span><span class="n">set_precision</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">o</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">o</span> <span class="o">=</span> <span class="n">fp</span><span class="p">(</span><span class="s">&quot;.9985&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">o</span><span class="o">.</span><span class="n">set_precision</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">o</span> <span class="o">==</span> <span class="n">fp</span><span class="p">(</span><span class="s">&quot;.998&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">o</span> <span class="o">==</span> <span class="n">o</span><span class="o">.</span><span class="n">frac</span><span class="p">()</span>
    <span class="n">o</span><span class="o">.</span><span class="n">set_precision</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">o</span> <span class="o">==</span> <span class="n">fp</span><span class="p">(</span><span class="s">&quot;.998&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">o</span><span class="o">.</span><span class="n">set_precision</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">o</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">fp</span><span class="p">(</span><span class="mf">1.99</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">long</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="nb">long</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="il">1L</span>
    <span class="k">assert</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">x</span> <span class="o">==</span> <span class="nb">long</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">frac</span><span class="p">()</span>
    <span class="k">assert</span> <span class="o">-</span><span class="n">x</span> <span class="o">==</span> <span class="nb">long</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">frac</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">fp</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">7</span> <span class="o">%</span> <span class="n">fp</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="k">assert</span> <span class="n">fp</span><span class="p">(</span><span class="o">-</span><span class="mi">7</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="o">-</span><span class="mi">7</span> <span class="o">%</span> <span class="n">fp</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">fp</span><span class="p">(</span><span class="o">-</span><span class="mi">7</span><span class="p">)</span> <span class="o">%</span> <span class="o">-</span><span class="mi">4</span> <span class="o">==</span> <span class="o">-</span><span class="mi">7</span> <span class="o">%</span> <span class="n">fp</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">3</span>
    <span class="k">assert</span> <span class="n">fp</span><span class="p">(</span><span class="mf">7.0</span><span class="p">)</span> <span class="o">%</span> <span class="s">&quot;-4.0&quot;</span> <span class="o">==</span> <span class="mi">7</span> <span class="o">%</span> <span class="n">fp</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">assert</span> <span class="n">fp</span><span class="p">(</span><span class="s">&quot;5.5&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">fp</span><span class="p">(</span><span class="s">&quot;1.1&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">fp</span><span class="p">(</span><span class="s">&quot;5.5e100&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">fp</span><span class="p">(</span><span class="s">&quot;1.1e100&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">fp</span><span class="p">(</span><span class="s">&quot;1e100&quot;</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="nb">long</span><span class="p">(</span><span class="n">fp</span><span class="p">(</span><span class="s">&quot;1e100&quot;</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">_test</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/topo-banner7.png" alt="Logo"/>
            </a></p>
<ul class="global-toc">

<li><a href="../../../index.html">Home</a></li>
<li><a href="../../../News/index.html">News</a></li>
<li><a href="../../../Downloads/index.html">Downloads</a></li>
<li><a href="../../../Tutorials/index.html">Tutorials</a></li>
<li><a href="../../../User_Manual/index.html">User Manual</a></li>
<li><a href="../../../Reference_Manual/index.html">Reference Manual</a></li>
<li><a href="../../../Developer_Manual/index.html">Developer Manual</a></li>
<li><a href="http://github.com/ioam/topographica">Github Source Code</a></li>
<li><a href="../../../Forums/index.html">Forums</a></li>
<li><a href="../../../Team_Members/index.html">Team Members</a></li>
<li><a href="../../../Future_Work/index.html">Future Work</a></li>
<li><a href="../../../FAQ/index.html">FAQ</a></li>
<li><a href="../../../Links/index.html">Links</a></li>
<li><a href="../../../Home/pubs.html">Publications</a></li>
<li><a href="../../../site_map.html">Site Map</a></li>
</ul>
<h3><a href="../../../index.html">Table Of Contents</a></h3>



<h3>This Page</h3>
<ul class="this-page-menu">
	<li><a	href="https://github.com/ioam/topographica/edit/master/doc/_modules/topo/misc/fixedpoint.rst" rel="nofollow">Edit on GitHub</a></li>
    <li><a	href="http://doozy.inf.ed.ac.uk:8010/builders/topographica_docs" rel="nofollow">Rebuild docs</a></li>
</ul>

<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>

<li><a href="../../../index.html">Home</a></li>
<li><a href="../../../Downloads/index.html">Downloads</a></li>
<li><a href="../../../Tutorials/index.html">Tutorials</a></li>
<li><a href="../../../User_Manual/index.html">User Manual</a></li>



<li><ul class="parents">



          <li><a href="../../index.html" >Module code</a> &raquo;</li>

</ul></li>


      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, IOAM.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>